<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="Keywords" content="统一登陆"/>
    <meta name="Description" content="统一登录"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0">
    <link rel="icon" href="/static/img/icon.png" type="image/x-icon">
    <link rel="shortcut icon" href="/static/img/icon.png" type="image/x-icon">
    <script src="/static/js/jquery-3.4.1/jquery-3.4.1.min.js"></script>
    <link rel="stylesheet" href="/static/css/custom.css" type="text/css">
    <title>登录</title>
</head>

<body>
<div class="container">
    <div class="login-frame frame_turn">
        <div class="login-wrapper shadow">
            <div class="header">登录</div>
            <div class="form-wrapper">
                <input type="text" name="username" placeholder="用户名" class="input-item">
                <input type="password" name="password" placeholder="密码" class="input-item">
                <div><img alt="验证码" id="captchaImg" src="/captcha" onclick="refreshImg()"></div>
                <input type="text" name="captcha" placeholder="验证码" class="input-item">
                <div class="btn pointer btn-login">登录</div>
            </div>
            <div class="msg">
                <p>Don't have account?
                    <a href="#">Sign up</a>
                </p>
            </div>
            <div id="errorMsg"></div>
        </div>
    </div>
</div>

<script>
    let clientId
    let redirectUri
    $(function () {
        clientId = getQueryString('clientId')
        redirectUri = getQueryString('redirect')
        if (!clientId || !redirectUri) {
            $('#errorMsg').html('授权参数有误')
            $('[name="username"]').attr('disabled', true)
            $('[name="password"]').attr('disabled', true)
            $('[name="captcha"]').attr('disabled', true)
            doing = true
        }

        $('.btn-login').click(login)

        autoPosition()

        $(window).resize(autoPosition)
    })

    function autoPosition() {
        // 计算容器位置
        var container = $('.login-frame');
        var containerWidth = container.width();
        var containerHeight = container.height();
        var viewportWidth = $(window).width();
        var viewportHeight = $(window).height();
        var left = (viewportWidth - containerWidth) / 2;
        var top = (viewportHeight - containerHeight) / 2;
        container.css({'left': left, 'top': top});
    }

    var doing = false

    function refreshImg() {
        let num = Math.ceil(Math.random() * 1000)
        let captchaUrlTmp = $('#captchaImg').attr('src').split('?')[0]
        let captchaUrl = [captchaUrlTmp, 'code=' + num].join('?')
        $('#captchaImg').attr('src', captchaUrl)
        $('[name="captcha"]').val('')
    }

    function login() {
        if (doing) {
            return
        }
        let errorMsg = $('#errorMsg')
        errorMsg.html('')
        let username = $('[name="username"]').val()
        let password = $('[name="password"]').val()
        let captcha = $('[name="captcha"]').val()
        if (!username) {
            errorMsg.html('请输入用户名')
            return;
        }
        if (!password) {
            errorMsg.html('请输入密码')
            return;
        }
        if (!captcha) {
            errorMsg.html('请输入验证码')
            return;
        }
        $('.login-frame').removeClass('frame_turn')
        $('.login-wrapper').addClass('Frame_exit')
        doing = true
        $(this).html('登陆中...')
        let _this = this
        $.ajax({
            url: '/login',
            type: 'post',
            contentType: 'application/x-www-form-urlencoded',
            data: {
                username: username,
                password: password,
                captcha: captcha,
                type: 'PASSWORD',
                clientId: clientId,
                redirectUri: redirectUri
            },
            success: function (res) {
                $('.login-frame').addClass('frame_turn')
                $('.login-wrapper').removeClass('Frame_exit')
                console.log('登录成功,跳转认证地址')
                doing = false
                if (res.code === 200) {
                    $(_this).html('登陆成功')
                    window.location = res.data.authorizeUrl
                } else {
                    $('#errorMsg').html(res.msg)
                    refreshImg()
                    $(_this).html('登陆')
                }
            },
            error: function () {
                doing = false
                $('.login-frame').addClass('frame_turn')
                $('.login-wrapper').removeClass('Frame_exit')
                $('#errorMsg').html('请求异常')
                refreshImg()
                $(_this).html('登陆')
            }
        })

    }

    /**
     * 获取url参数
     **/
    function getQueryString(name) {
        const reg = new RegExp('(^|&)' + name + '=([^&]*)(&|$)')
        const r = window.location.search.substr(1).match(reg)
        if (r != null) {
            return unescape(r[2])
        }
        return ''
    }
</script>
</body>

</html>
