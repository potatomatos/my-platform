<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="Keywords" content="统一登陆"/>
    <meta name="Description" content="统一登录"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0">
    <link rel="icon" href="/static/img/icon.png" type="image/x-icon">
    <link rel="shortcut icon" href="/static/img/icon.png" type="image/x-icon">
    <script src="/static/js/jquery-3.4.1/jquery-3.4.1.min.js"></script>
    <script src="/static/js/layer/layer.js"></script>
    <link rel="stylesheet" href="/static/css/font-awesome-4.7.0/css/font-awesome.min.css" type="text/css">
    <link rel="stylesheet" href="/static/css/custom.css" type="text/css">
    <title>登录</title>
</head>

<body>
<div class="container">
    <div class="login-frame frame_turn">
        <div class="login-wrapper shadow">
            <div class="header">登录</div>
            <div class="to-user-login">
                <i class="fa fa-arrow-left fa-2x"></i>
            </div>
            <!--账号密码登录-->
            <div class="username-login">
                <input type="text" name="username" placeholder="用户名" class="input-item">
                <input type="password" name="password" placeholder="密码" class="input-item">
                <div><img alt="验证码" id="captchaImg" src="/captcha" onclick="refreshImg()"></div>
                <input type="text" name="captcha" placeholder="验证码" class="input-item">
                <div class="btn pointer btn-login">登录</div>
            </div>
            <!--短信登录-->
            <div class="smg-login">
                <input type="text" name="phoneNumber" placeholder="手机号" class="input-item">
                <div class="verification-code-wrap">
                    <input type="text" name="verificationCode" placeholder="验证码" class="input-item verification-code">
                    <div class="btn pointer btn-get-verification-code">获取验证码</div>
                </div>
                <div class="btn pointer btn-smg-login">登录</div>
            </div>
            <ul class="social-account">
                <li><i class="fa fa-github fa-2x"></i></li>
                <li><i class="fa fa-weixin fa-2x"></i></li>
                <li><i class="fa fa-qq fa-2x"></i></li>
                <li>
                    <svg t="1711373813055" class="icon" viewBox="0 0 1413 1024" version="1.1"
                         xmlns="http://www.w3.org/2000/svg" p-id="1776"
                         width="28" height="24">
                        <path d="M595.747843 0.05027S484.447872-5.019729 413.499891 86.676247c-70.971981 91.719976-17.675995 231.764939 15.969996 304.02992 33.645991 72.239981 211.235944 355.765906 217.745942 362.007905 6.484998 6.240998 14.286996 3.607999 14.701996-2 0.438-5.558999 20.283995-411.963891 4.314999-512.169865C650.262829 138.340234 602.939841 11.046267 595.722843 0.05027zM211.211944 188.97822c-12.726997 1.365-103.984973 92.379976-112.22497 181.369952-8.265998 88.989977 29.816992 148.186961 136.166964 219.037943 107.056972 75.92198 361.495905 215.575943 366.152903 203.531946 4.679999-11.995997-98.571974-195.486948-183.100951-328.922913-84.503978-133.460965-194.339949-276.381927-206.993946-275.016928z m34.205991 820.831784c76.99498 34.425991 196.949948-42.909989 230.13194-65.364983 30.865992-23.575994 87.868977-66.925982 87.868976-66.925982l-436.296885 11.678997s41.300989 86.185977 118.295969 120.611968z m10.971997-352.547907c-78.091979-39.10699-238.737937-128.925966-245.027935-127.169967-6.289998 1.706-30.476992 113.41997 19.747995 197.606948 50.249987 84.186978 148.089961 109.932971 192.974949 116.783969 50.492987 7.216998 347.305908 3.998999 345.330909-1.974999-1.755-5.216999-234.909938-146.211961-313.049918-185.245951zM980.234742 86.700247C909.28576-5.020729 798.03579 0.05027 798.03579 0.05027c-7.239998 10.971997-54.563986 138.288964-70.533982 238.518937-15.969996 100.204974 3.925999 506.585866 4.363999 512.144865 0.415 5.607999 8.167998 8.240998 14.677996 2 6.484998-6.241998 184.099951-289.767924 217.745943-362.007905 33.620991-72.264981 86.917977-212.309944 15.944996-304.02992z m402.162894 443.390883c-6.289998-1.706-166.935956 88.088977-245.027936 127.170967-78.067979 39.03399-311.270918 180.052953-312.977917 185.245951-2.023999 5.973998 294.789922 9.191998 345.282909 1.999999 44.884988-6.875998 142.724962-32.621991 192.973949-116.809969 50.273987-84.186978 26.014993-195.899948 19.748995-197.606948zM918.184758 944.445021c33.182991 22.479994 153.18596 99.790974 230.179939 65.364983 76.99598-34.425991 118.296969-120.611968 118.296969-120.611968L830.389781 877.519039s57.001985 43.349989 87.794977 66.925982z m376.636901-574.096849c-8.289998-88.989977-99.547974-180.004953-112.200971-181.393952-12.726997-1.341-122.562968 141.579963-207.066945 275.015928-84.504978 133.460965-187.78195 316.951916-183.100952 328.947913 4.680999 12.043997 259.144932-127.609966 366.152904-203.531946 106.349972-70.826981 144.479962-130.047966 136.215964-219.037943z"
                              p-id="1777"></path>
                    </svg>
                </li>
                <li>
                    <svg t="1711373465225" class="icon" viewBox="0 0 1024 1024" version="1.1"
                         xmlns="http://www.w3.org/2000/svg" p-id="1598" width="24" height="24"
                    >
                        <path d="M512 0C229.2 0 0 229.2 0 512s229.2 512 512 512 512-229.2 512-512S794.8 0 512 0z m-33.2 680.5c0 2.1-1.7 3.9-3.9 3.9h-74.6c-2.2 0-3.9-1.7-3.9-3.9V477.7c0-2.1 1.7-3.9 3.9-3.9h74.6c2.2 0 3.9 1.7 3.9 3.9v202.8z m146.8 3.9h-73.5c-2.1 0-3.9-1.7-3.9-3.9V466.6c0-30.1-24.4-54.6-54.6-54.6H333.2c-2.2 0-3.9 1.7-3.9 3.9v264.6c0 2.1-1.7 3.9-3.9 3.9h-74.6c-2.2 0-3.9-1.7-3.9-3.9V343.4c0-2.1 1.7-3.9 3.9-3.9h279.3c54.9 0 99.4 44.5 99.4 99.4v241.6c0 2.2-1.8 3.9-3.9 3.9z m151.5-3.9c0 2.1-1.7 3.9-3.9 3.9h-74.6c-2.2 0-3.9-1.7-3.9-3.9v-337c0-2.2 1.8-3.9 3.9-3.9h74.6c2.2 0 3.9 1.7 3.9 3.9v337z"
                              p-id="1599"></path>
                    </svg>
                </li>
                <li class="smg"><i class="fa fa-mobile fa-3x"></i></li>
            </ul>
            <div class="msg">
                <a href="#">注册账号</a>
            </div>
            <div id="errorMsg"></div>
        </div>
    </div>
</div>

<script>
    let clientId
    let redirectUri
    $(function () {
        clientId = getQueryString('clientId')
        redirectUri = getQueryString('redirect')
        if (!clientId || !redirectUri) {
            $('#errorMsg').html('授权参数有误')
            $('[name="username"]').attr('disabled', true)
            $('[name="password"]').attr('disabled', true)
            $('[name="captcha"]').attr('disabled', true)
            doing = true
        }

        $('.btn-login').click(login)

        /**
         * 切换到短信登录
         */
        $('.smg').click(function () {
            $('.to-user-login').show()
            $('.smg-login').show()
            $('.username-login').hide()
        })

        /**
         * 切换到用户密码登录
         */
        $('.to-user-login').click(function () {
            $('.to-user-login').hide()
            $('.smg-login').hide()
            $('.username-login').show()
        })

        autoPosition()
        $(window).resize(autoPosition)
    })

    function autoPosition() {
        // 计算容器位置
        var container = $('.login-frame');
        var containerWidth = container.width();
        var containerHeight = container.height();
        var viewportWidth = $(window).width();
        var viewportHeight = $(window).height();
        var left = (viewportWidth - containerWidth) / 2;
        var top = (viewportHeight - containerHeight) / 2;
        container.css({'left': left, 'top': top});
    }

    var doing = false

    function refreshImg() {
        let num = Math.ceil(Math.random() * 1000)
        let captchaUrlTmp = $('#captchaImg').attr('src').split('?')[0]
        let captchaUrl = [captchaUrlTmp, 'code=' + num].join('?')
        $('#captchaImg').attr('src', captchaUrl)
        $('[name="captcha"]').val('')
    }

    //用户名密码登录
    function login() {
        if (doing) {
            return
        }
        let errorMsg = $('#errorMsg')
        errorMsg.html('')
        let username = $('[name="username"]').val()
        let password = $('[name="password"]').val()
        let captcha = $('[name="captcha"]').val()
        if (!username) {
            errorMsg.html('请输入用户名')
            return;
        }
        if (!password) {
            errorMsg.html('请输入密码')
            return;
        }
        if (!captcha) {
            errorMsg.html('请输入验证码')
            return;
        }
        $('.login-frame').removeClass('frame_turn')
        $('.login-wrapper').addClass('Frame_exit')
        doing = true
        $(this).html('登陆中...')
        let _this = this
        $.ajax({
            url: '/login',
            type: 'post',
            contentType: 'application/x-www-form-urlencoded',
            data: {
                username: username,
                password: password,
                captcha: captcha,
                type: 'PASSWORD',
                clientId: clientId,
                redirectUri: redirectUri
            },
            success: function (res) {
                $('.login-frame').addClass('frame_turn')
                $('.login-wrapper').removeClass('Frame_exit')
                console.log('登录成功,跳转认证地址')
                doing = false
                if (res.code === 200) {
                    $(_this).html('登陆成功')
                    window.location = res.data.authorizeUrl
                } else {
                    $('#errorMsg').html(res.msg)
                    refreshImg()
                    $(_this).html('登陆')
                }
            },
            error: function () {
                doing = false
                $('.login-frame').addClass('frame_turn')
                $('.login-wrapper').removeClass('Frame_exit')
                $('#errorMsg').html('请求异常')
                refreshImg()
                $(_this).html('登陆')
            }
        })

    }

    /**
     * 获取url参数
     **/
    function getQueryString(name) {
        const reg = new RegExp('(^|&)' + name + '=([^&]*)(&|$)')
        const r = window.location.search.substr(1).match(reg)
        if (r != null) {
            return unescape(r[2])
        }
        return ''
    }
</script>
</body>

</html>
